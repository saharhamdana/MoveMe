// ==========================================
// RIDE REQUESTS PAGE - DEMANDES DE COURSES (CHAUFFEUR)
// ==========================================
import { Component, OnInit, OnDestroy } from '@angular/core';
import { CommonModule } from '@angular/common';
import { Router } from '@angular/router';
import {
  IonHeader,
  IonToolbar,
  IonTitle,
  IonContent,
  IonCard,
  IonCardContent,
  IonCardHeader,
  IonCardTitle,
  IonButton,
  IonIcon,
  IonText,
  IonBadge,
  IonRefresher,
  IonRefresherContent,
  IonSpinner,
  IonButtons,
  IonBackButton,
  AlertController,
  ToastController,
  LoadingController
} from '@ionic/angular/standalone';
import { addIcons } from 'ionicons';
import {
  locationOutline,
  navigateOutline,
  cashOutline,
  timeOutline,
  personOutline,
  callOutline,
  closeOutline,
  checkmarkOutline,
  carSportOutline
} from 'ionicons/icons';

import { AuthService } from '../../../core/services/auth.service';
import { RideService } from '../../../core/services/ride.service';
import { Ride } from '../../../shared/models/interfaces';
import { Database, ref, get } from '@angular/fire/database';
import { Subscription } from 'rxjs';

@Component({
  selector: 'app-ride-requests',
  templateUrl: './ride-requests.page.html',
  styleUrls: ['./ride-requests.page.scss'],
  standalone: true,
  imports: [
    CommonModule,
    IonHeader,
    IonToolbar,
    IonTitle,
    IonContent,
    IonCard,
    IonCardContent,
    IonCardHeader,
    IonCardTitle,
    IonButton,
    IonIcon,
    IonText,
    IonBadge,
    IonRefresher,
    IonRefresherContent,
    IonSpinner,
    IonButtons,
    IonBackButton
  ]
})
export class RideRequestsPage implements OnInit, OnDestroy {
  
  // ==========================================
  // PROPRI√âT√âS
  // ==========================================
  pendingRides: Ride[] = [];
  isLoading: boolean = true;
  driverData: any = null;
  currentUser: any = null;
  
  // Subscription pour √©viter les fuites m√©moire
  private ridesSubscription?: Subscription;
  private isPageActive = false;

  constructor(
    private authService: AuthService,
    private rideService: RideService,
    private database: Database,
    private router: Router,
    private alertCtrl: AlertController,
    private toastCtrl: ToastController,
    private loadingCtrl: LoadingController
  ) {
    // Enregistrer TOUTES les ic√¥nes n√©cessaires
    addIcons({
      locationOutline,
      navigateOutline,
      cashOutline,
      timeOutline,
      personOutline,
      callOutline,
      closeOutline,
      checkmarkOutline,
      carSportOutline // ‚úÖ Ajout de l'ic√¥ne car-outline
    });
  }

  // ==========================================
  // INITIALISATION
  // ==========================================
  async ngOnInit() {
    console.log('üöÄ RideRequestsPage initialized');
    this.isPageActive = true;
    
    // R√©cup√©rer l'utilisateur connect√©
    this.currentUser = this.authService.currentUser;
    
    if (!this.currentUser) {
      console.error('‚ùå No user logged in');
      this.showToast('Veuillez vous connecter', 'danger');
      this.router.navigate(['/login']);
      return;
    }
    
    // Charger les donn√©es du chauffeur
    await this.loadDriverData(this.currentUser.uid);
    
    // Charger les courses en attente
    this.loadPendingRides();
  }

  // ==========================================
  // CYCLE DE VIE IONIC - ENTR√âE
  // ==========================================
  ionViewWillEnter() {
    console.log('üëÄ View entering...');
    this.isPageActive = true;
    
    // Red√©marrer l'√©coute si l'utilisateur est connect√©
    if (this.currentUser) {
      this.rideService.startListeningToPendingRides();
    }
  }

  // ==========================================
  // CYCLE DE VIE IONIC - SORTIE
  // ==========================================
  ionViewWillLeave() {
    console.log('üëã View leaving...');
    this.isPageActive = false;
    
    // Arr√™ter l'√©coute pour √©conomiser les ressources
    this.rideService.stopListeningToPendingRides();
  }

  // ==========================================
  // CHARGER LES DONN√âES DU CHAUFFEUR
  // ==========================================
  async loadDriverData(driverId: string) {
    try {
      console.log('üì• Loading driver data for:', driverId);
      const driverRef = ref(this.database, `drivers/${driverId}`);
      const snapshot = await get(driverRef);
      
      if (snapshot.exists()) {
        this.driverData = snapshot.val();
        console.log('‚úÖ Driver data loaded:', this.driverData);
      } else {
        console.warn('‚ö†Ô∏è No driver data found');
      }
    } catch (error) {
      console.error('‚ùå Error loading driver data:', error);
    }
  }

  // ==========================================
  // CHARGER LES DEMANDES EN ATTENTE
  // ==========================================
  loadPendingRides() {
    console.log('üîÑ Loading pending rides...');
    this.isLoading = true;
    
    // Se d√©sabonner de l'ancienne subscription si elle existe
    if (this.ridesSubscription) {
      this.ridesSubscription.unsubscribe();
    }
    
    // S'abonner aux courses en attente (Observable RxJS)
    this.ridesSubscription = this.rideService.pendingRides$.subscribe({
      next: (rides) => {
        // Ne mettre √† jour que si la page est active
        if (this.isPageActive) {
          this.pendingRides = rides;
          this.isLoading = false;
          console.log('üìã Pending rides updated:', rides.length);
        }
      },
      error: (error) => {
        console.error('‚ùå Error subscribing to rides:', error);
        this.isLoading = false;
      }
    });
    
    // ‚úÖ D√©marrer l'√©coute Firebase en temps r√©el (SYNCHRONE maintenant)
    this.rideService.startListeningToPendingRides();
  }

  // ==========================================
  // ACCEPTER UNE COURSE
  // ==========================================
  async acceptRide(ride: Ride) {
    if (!this.currentUser || !this.driverData) {
      this.showToast('‚ùå Erreur: Donn√©es manquantes', 'danger');
      return;
    }

    // V√©rifier le v√©hicule
    if (!this.driverData.vehicleInfo) {
      const alert = await this.alertCtrl.create({
        header: 'üöó V√©hicule non configur√©',
        message: 'Vous devez configurer votre v√©hicule avant d\'accepter des courses.',
        buttons: [
          {
            text: 'OK',
            handler: () => {
              this.router.navigate(['/driver/tabs/profile']);
            }
          }
        ]
      });
      await alert.present();
      return;
    }

    // Confirmation avec d√©tails
    const alert = await this.alertCtrl.create({
      header: '‚úÖ Accepter la course',
      message: `
        <div style="text-align: left; line-height: 1.8;">
          <strong>üìç D√©part:</strong><br>
          ${ride.pickupLocation.address || 'Position de d√©part'}<br><br>
          
          <strong>üéØ Destination:</strong><br>
          ${ride.dropoffLocation.address || 'Destination'}<br><br>
          
          <strong>üí∞ Prix estim√©:</strong> ${ride.estimatedPrice} DT<br>
          <strong>üìè Distance:</strong> ${this.formatDistance(ride.estimatedDistance)}<br>
          <strong>‚è±Ô∏è Dur√©e:</strong> ${this.formatDuration(ride.estimatedDuration)}
        </div>
      `,
      buttons: [
        {
          text: 'Annuler',
          role: 'cancel',
          cssClass: 'secondary'
        },
        {
          text: 'Accepter',
          cssClass: 'primary',
          handler: async () => {
            await this.confirmAcceptRide(ride);
          }
        }
      ]
    });

    await alert.present();
  }

  // ==========================================
  // CONFIRMER L'ACCEPTATION
  // ==========================================
  async confirmAcceptRide(ride: Ride) {
    if (!this.currentUser) {
      this.showToast('‚ùå Erreur: Utilisateur non connect√©', 'danger');
      return;
    }

    const loading = await this.loadingCtrl.create({
      message: 'Acceptation de la course...',
      spinner: 'crescent'
    });
    await loading.present();

    try {
      // Pr√©parer les donn√©es du chauffeur
      const driverInfo = {
        name: this.currentUser.displayName || this.driverData?.name || 'Chauffeur',
        phone: this.currentUser.phoneNumber || this.driverData?.phone || '',
        photoURL: this.currentUser.photoURL || this.driverData?.photoURL || '',
        vehicleInfo: this.driverData.vehicleInfo
      };

      console.log('‚úÖ Accepting ride with data:', driverInfo);

      // Accepter la course
      await this.rideService.acceptRide(ride.id, this.currentUser.uid, driverInfo);

      await loading.dismiss();
      
      // Toast de succ√®s
      this.showToast('‚úÖ Course accept√©e avec succ√®s !', 'success');
      
      // Rediriger vers la page d'accueil du chauffeur
      this.router.navigate(['/driver/tabs/home']);
      
    } catch (error: any) {
      await loading.dismiss();
      console.error('‚ùå Error accepting ride:', error);
      
      // Afficher un message d'erreur appropri√©
      let errorMessage = 'Erreur lors de l\'acceptation de la course';
      
      if (error.message?.includes('plus disponible')) {
        errorMessage = '‚ö†Ô∏è Cette course a d√©j√† √©t√© accept√©e par un autre chauffeur';
      } else if (error.message) {
        errorMessage = error.message;
      }
      
      this.showToast(errorMessage, 'danger');
    }
  }

  // ==========================================
  // IGNORER UNE COURSE
  // ==========================================
  async declineRide(ride: Ride) {
    // Confirmation rapide
    const alert = await this.alertCtrl.create({
      header: 'Ignorer la course',
      message: '√ätes-vous s√ªr de vouloir ignorer cette course ?',
      buttons: [
        {
          text: 'Annuler',
          role: 'cancel'
        },
        {
          text: 'Ignorer',
          role: 'destructive',
          handler: () => {
            // Retirer de la liste locale
            this.pendingRides = this.pendingRides.filter(r => r.id !== ride.id);
            this.showToast('Course ignor√©e', 'medium');
          }
        }
      ]
    });

    await alert.present();
  }

  // ==========================================
  // RAFRA√éCHIR
  // ==========================================
  async handleRefresh(event: any) {
    console.log('üîÑ Refreshing rides...');
    
    // Red√©marrer l'√©coute (les donn√©es sont d√©j√† en temps r√©el)
    this.rideService.stopListeningToPendingRides();
    this.rideService.startListeningToPendingRides();
    
    // Attendre un peu pour l'effet visuel
    setTimeout(() => {
      event.target.complete();
      console.log('‚úÖ Refresh complete');
    }, 500);
  }

  // ==========================================
  // TEMPS √âCOUL√â
  // ==========================================
  getTimeAgo(date: Date): string {
    const now = new Date();
    const diff = Math.floor((now.getTime() - date.getTime()) / 1000);
    
    if (diff < 60) return `Il y a ${diff}s`;
    if (diff < 3600) return `Il y a ${Math.floor(diff / 60)}min`;
    if (diff < 86400) return `Il y a ${Math.floor(diff / 3600)}h`;
    return `Il y a ${Math.floor(diff / 86400)}j`;
  }

  // ==========================================
  // FORMATER LA DISTANCE
  // ==========================================
  formatDistance(distance: number): string {
    if (distance < 1) {
      return `${Math.round(distance * 1000)} m`;
    }
    return `${distance.toFixed(1)} km`;
  }

  // ==========================================
  // FORMATER LA DUR√âE
  // ==========================================
  formatDuration(duration: number): string {
    if (duration < 60) {
      return `${Math.round(duration)} min`;
    }
    const hours = Math.floor(duration / 60);
    const minutes = Math.round(duration % 60);
    return `${hours}h ${minutes}min`;
  }

  // ==========================================
  // TOAST
  // ==========================================
  private async showToast(message: string, color: 'success' | 'danger' | 'medium') {
    const toast = await this.toastCtrl.create({
      message: message,
      duration: 3000,
      position: 'top',
      color: color
    });
    await toast.present();
  }

  // ==========================================
  // NETTOYAGE
  // ==========================================
  ngOnDestroy() {
    console.log('üßπ Cleaning up RideRequestsPage...');
    this.isPageActive = false;
    
    // Se d√©sabonner de l'Observable
    if (this.ridesSubscription) {
      this.ridesSubscription.unsubscribe();
      this.ridesSubscription = undefined;
    }
    
    // Arr√™ter l'√©coute Firebase
    this.rideService.stopListeningToPendingRides();
    
    console.log('‚úÖ Cleanup complete');
  }
}